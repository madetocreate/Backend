import OpenAI from "openai";
import { type ExternalGreetingDeps } from "./defaultDeps";
import type { TopicSpec } from "./topicPlanner";
import type { NewsSearchResult } from "./newsFetcher";
import type { ProjectSummary } from "./projectCards";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

async function searchNewsForTopicWithOpenAI(
  topic: TopicSpec
): Promise<NewsSearchResult[]> {
  const prompt =
    "Du bist ein News-Aggregator für einen personalisierten News-Feed.\n" +
    "Thema: " +
    topic.label +
    "\n" +
    "Erzeuge eine JSON-Liste von höchstens 3 Newsartikeln.\n" +
    "Format: [{\"title\": string, \"summary\": string, \"url\": string, \"sourceName\": string, \"topicTag\": string}].\n" +
    "Schreibe ausschließlich gültiges JSON ohne zusätzlichen Text.";

  const response = await openai.responses.create({
    model: "gpt-4.1-mini",
    input: prompt,
    tools: [
      {
        type: "web_search"
      }
    ]
  });

  const text =
    (response as any).output_text ??
    ((((response as any).output || [])[0] || {}).content || [])[0]?.text ||
    "[]";

  let parsed: unknown = [];
  try {
    parsed = JSON.parse(text);
  } catch (e) {
    parsed = [];
  }

  const list = Array.isArray(parsed) ? parsed : [];
  return list.map((item: any): NewsSearchResult => {
    return {
      title: String(item.title ?? topic.label),
      summary: String(
        item.summary ?? "Kurzfassung der News zu " + topic.label + "."
      ),
      url: String(
        item.url ?? "https://example.com/news/" + encodeURIComponent(topic.label)
      ),
      sourceName: String(item.sourceName ?? "Unbekannte Quelle"),
      topicTag: String(item.topicTag ?? topic.label)
    };
  });
}

async function loadUserProfile(userId: string): Promise<unknown> {
  return {
    userId,
    newsTopics: ["AI Regulation", "Bundesliga", "Startups"],
    industries: ["ai", "software"]
  };
}

async function loadMemorySummary(userId: string): Promise<unknown> {
  return {
    userId,
    activeProjects: ["AI Bot", "Landing Page Relaunch"]
  };
}

async function loadActiveProjects(userId: string): Promise<ProjectSummary[]> {
  return [
    {
      id: "proj-1",
      name: "AI Begrüßungsmanager",
      nextStep: "Datenquellen verbinden und UI bauen",
      priority: 1
    },
    {
      id: "proj-2",
      name: "Marketing Landing Page",
      nextStep: "Hero-Section mit neuem Value-Proposition-Text testen",
      priority: 0.8
    }
  ];
}

export const externalDemoDeps: ExternalGreetingDeps = {
  loadUserProfile,
  loadMemorySummary,
  searchNewsForTopic: searchNewsForTopicWithOpenAI,
  loadActiveProjects
};
