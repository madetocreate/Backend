import { FastifyInstance } from "fastify";
import { z } from "zod";
import { createWunschOrder } from "../domain/wunschkasten/orderService";

const TrackEnum = z.enum(["marketing", "automation", "fun", "custom"]);
const AudienceEnum = z.enum(["business", "private", "mixed"]);

const StateSchema = z.object({
  track: TrackEnum.optional(),
  audience: AudienceEnum.optional(),
  goals: z.array(z.string()).optional(),
  platforms: z.array(z.string()).optional(),
  metadata: z.record(z.unknown()).optional(),
});

const OfferSchema = z.object({
  id: z.string().min(1),
  title: z.string().min(1),
  description: z.string().min(1),
  priceHint: z.string().optional(),
  deliveryTimeHint: z.string().optional(),
  tier: z.string().optional(),
  metadata: z.record(z.unknown()).optional(),
});

const OrderBodySchema = z.object({
  tenantId: z.string().min(1),
  sessionId: z.string().min(1),
  offer: OfferSchema,
  blueprintSummary: z.string().optional(),
  state: StateSchema.optional(),
  metadata: z.record(z.unknown()).optional(),
});

export async function registerWunschkastenOrderRoutes(
  app: FastifyInstance
): Promise<void> {
  app.post("/agent/wunschkasten/order", async (request, reply) => {
    const parseResult = OrderBodySchema.safeParse(request.body);

    if (!parseResult.success) {
      reply.status(400);
      return {
        error: "Invalid request body",
        details: parseResult.error.flatten(),
      };
    }

    const body = parseResult.data;

    const order = await createWunschOrder({
      tenantId: body.tenantId as any,
      sessionId: body.sessionId,
      audience: body.state?.audience as any,
      track: body.state?.track as any,
      offer: body.offer as any,
      blueprintSummary: body.blueprintSummary,
      stateSnapshot: body.state
        ? {
            tenantId: body.tenantId as any,
            sessionId: body.sessionId,
            track: body.state.track,
            audience: body.state.audience,
            goals: body.state.goals,
            platforms: body.state.platforms,
            metadata: body.state.metadata,
          }
        : undefined,
      metadata: body.metadata,
    });

    return order;
  });
}
